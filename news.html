<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>공동체 전체 보기 - 예수성심 천주교 커네티컷 성당</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" integrity="sha512-Fo3rlrZj/k7ujTnHg4CGR2D7kSs0v4LLanw2qksYuRlEzO+tcaEPQogQ0KaoGN26/zrn20ImR1DfuLWnOo7aBA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="preconnect" href="https://script.google.com" />
  <link rel="dns-prefetch" href="//script.google.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <!-- Basic hardening: CSP and Referrer Policy -->
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; img-src 'self' data: https://via.placeholder.com https://drive.google.com https://*.googleusercontent.com; script-src 'self' 'unsafe-inline' https://script.google.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdnjs.cloudflare.com; font-src https://fonts.gstatic.com https://cdnjs.cloudflare.com; frame-src https://drive.google.com; connect-src 'self' https://script.google.com;" />
  <meta name="referrer" content="no-referrer" />
  <style>
    body { font-family: 'Noto Sans KR', sans-serif; color: #333; margin: 0; }
    a { color: #3A66B0; text-decoration: none; }
    .container { max-width: 1100px; margin: 0 auto; padding: 20px; }
    header { background: #fff; border-bottom: 1px solid #eee; position: sticky; top: 0; z-index: 10; }
    header .container { display: flex; align-items: center; justify-content: space-between; }
    h1 { font-size: 1.2rem; margin: 0; }
    nav a { margin-left: 15px; }
    h2 { margin: 30px 0 10px; font-size: 1.6rem; }
    .card { background: #fff; border: 1px solid #eee; border-radius: 8px; padding: 16px; margin: 18px 0; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 10px 8px; border-bottom: 1px solid #f0f0f0; text-align: left; vertical-align: top; }
    th { background: #f9fbff; color: #2f4d7a; }
    tr:hover td { background: #fafafa; }
    .title-cell { font-weight: 700; }
    .date-cell { white-space: nowrap; color: #666; }
    .thumb { width: 64px; height: 48px; object-fit: cover; border-radius: 4px; background: #eee; }
    .actions a.btn { display: inline-block; padding: 6px 10px; border: 1px solid #3A66B0; color: #3A66B0; border-radius: 6px; font-size: 0.9rem; }
    .actions a.btn:hover { background: #3A66B0; color: #fff; }
    .expander { cursor: pointer; color: #3A66B0; }
    .content-row td { background: #fcfcff; }
    .content-box { padding: 8px 4px; color: #555; }
    .pagination { margin-top: 12px; text-align: center; }
    .pagination button { margin: 0 4px; padding: 6px 10px; border: 1px solid #ccc; background: #fff; cursor: pointer; border-radius: 4px; }
    .pagination button.active { background: #3A66B0; color: #fff; border-color: #3A66B0; }
  .section-desc { color: #666; margin-top: -4px; margin-bottom: 10px; font-size: 0.95rem; }
  footer { border-top: 1px solid #eee; color: #666; font-size: 0.9rem; padding: 20px 0; text-align: center; }

  /* Album inline embed */
  .embed-row td { background: #f7faff; }
  .embed-box { display: none; padding: 8px 0 0; }
  .drive-embed { width: 100%; height: 560px; border: 0; border-radius: 6px; background: #fff; }
  .hint { color: #666; font-size: 0.9rem; margin-bottom: 8px; }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <h1><a href="./index.html">예수성심 천주교 커네티컷 성당</a></h1>
      <nav>
        <a href="./index.html">메인으로</a>
        <a href="#ann">공지사항</a>
        <a href="#bul">주보</a>
        <a href="#alb">앨범</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <section id="ann" class="card">
      <h2>공지사항</h2>
      <p class="section-desc">최신 10개씩 표기됩니다. 제목을 클릭하면 본문이 펼쳐집니다.</p>
      <div class="table-wrap">
        <table aria-label="공지사항 표">
          <thead>
            <tr><th style="width:120px">일자</th><th>제목</th><th style="width:120px">동작</th></tr>
          </thead>
          <tbody id="ann-tbody"></tbody>
        </table>
        <div id="ann-pager" class="pagination"></div>
      </div>
    </section>

    <section id="bul" class="card">
      <h2>주보</h2>
      <p class="section-desc">최신 10개씩 표기됩니다. 보기 클릭 시 새 창으로 열립니다.</p>
      <div class="table-wrap">
        <table aria-label="주보 표">
          <thead>
            <tr><th style="width:120px">일자</th><th>제목</th><th style="width:120px">보기</th></tr>
          </thead>
          <tbody id="bul-tbody"></tbody>
        </table>
        <div id="bul-pager" class="pagination"></div>
      </div>
    </section>

    <section id="alb" class="card">
      <h2>앨범</h2>
      <p class="section-desc">최신 10개씩 표기됩니다. 열기 후 비밀번호를 통과하면 이 페이지 안에서 폴더가 바로 보입니다.</p>
      <div class="table-wrap">
        <table aria-label="앨범 표">
          <thead>
            <tr><th style="width:120px">일자</th><th>제목</th><th style="width:120px">썸네일</th><th style="width:120px">열기</th></tr>
          </thead>
          <tbody id="alb-tbody"></tbody>
        </table>
        <div id="alb-pager" class="pagination"></div>
      </div>
    </section>
  </main>

  <footer>
    <div class="container">&copy; 2025 예수성심 천주교 커네티컷 성당</div>
  </footer>

  <script>
    // 환경 설정 (배포 URL로 교체하세요)
    const CONFIG = {
  // Prefer static local JSON for speed; fallback URLs point to GAS
  ANNOUNCEMENTS_STATIC: './data/announcements.json',
  BULLETINS_STATIC: './data/bulletins.json',
  ALBUMS_STATIC: './data/albums.json',
  ANNOUNCEMENTS_URL: 'https://script.google.com/macros/s/AKfycbzivlp1VLwa6aIT9AksAkydRwOSp1kuThbBxl8UjzHt0ShMM56K91lpQIyRCDaW2kcsng/exec?type=ann',
  BULLETINS_URL: 'https://script.google.com/macros/s/AKfycbzivlp1VLwa6aIT9AksAkydRwOSp1kuThbBxl8UjzHt0ShMM56K91lpQIyRCDaW2kcsng/exec?type=bulletin',
  ALBUMS_URL: 'https://script.google.com/macros/s/AKfycbzivlp1VLwa6aIT9AksAkydRwOSp1kuThbBxl8UjzHt0ShMM56K91lpQIyRCDaW2kcsng/exec?type=albums',
      ALBUM_GATE_URL: 'https://script.google.com/macros/s/AKfycbzivlp1VLwa6aIT9AksAkydRwOSp1kuThbBxl8UjzHt0ShMM56K91lpQIyRCDaW2kcsng/exec'
    };

    const pageSize = 10;

    function fmtDate(d) {
      if (d == null) return '';
      // If already like 2025-09-02... just slice
      if (typeof d === 'string') {
        const s = d.trim();
        const iso = s.match(/^(\d{4}-\d{2}-\d{2})/);
        if (iso) return iso[1];
        // Handle M/D/YYYY or MM/DD/YYYY
        const mdY = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{2,4})$/);
        if (mdY) {
          const y = mdY[3].length === 2 ? ('20' + mdY[3]) : mdY[3];
          const m = String(mdY[1]).padStart(2, '0');
          const dd = String(mdY[2]).padStart(2, '0');
          return `${y}-${m}-${dd}`;
        }
        const d2 = new Date(s);
        if (!isNaN(d2.getTime())) {
          const y = d2.getFullYear();
          const m = String(d2.getMonth() + 1).padStart(2, '0');
          const dd = String(d2.getDate()).padStart(2, '0');
          return `${y}-${m}-${dd}`;
        }
        return s; // unknown format -> return as-is
      }
      if (typeof d === 'number') {
        // Heuristic: large => ms epoch; small => Google Sheets serial (days since 1899-12-30)
        let dateObj;
        if (d > 1e12) dateObj = new Date(d); else if (d > 10000) dateObj = new Date(d); else {
          const epoch = new Date(Date.UTC(1899, 11, 30));
          dateObj = new Date(epoch.getTime() + d * 86400000);
        }
        if (!isNaN(dateObj.getTime())) {
          const y = dateObj.getFullYear();
          const m = String(dateObj.getMonth() + 1).padStart(2, '0');
          const dd = String(dateObj.getDate()).padStart(2, '0');
          return `${y}-${m}-${dd}`;
        }
        return String(d);
      }
      if (d instanceof Date && !isNaN(d.getTime())) {
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, '0');
        const dd = String(d.getDate()).padStart(2, '0');
        return `${y}-${m}-${dd}`;
      }
      return String(d);
    }

    const dateKey = (d) => fmtDate(d) || '';

    // Escape HTML to prevent XSS when rendering body content from Sheets
    function escapeHTML(s) {
      return String(s).replace(/[&<>"']/g, (c) => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[c]));
    }

    function paginate(data, page) {
      const total = data.length;
      const pages = Math.max(1, Math.ceil(total / pageSize));
      const start = (page - 1) * pageSize;
      const end = start + pageSize;
      return { slice: data.slice(start, end), total, pages, page };
    }

    function renderPager(el, pages, current, onPage) {
      el.innerHTML = '';
      for (let i = 1; i <= pages; i++) {
        const btn = document.createElement('button');
        btn.textContent = String(i);
        if (i === current) btn.classList.add('active');
        btn.addEventListener('click', () => onPage(i));
        el.appendChild(btn);
      }
    }

    // Simple sessionStorage cache to reduce network latency across navigations
  function fetchJsonCached(url, key, ttlMs = 180000) { // default 3 minutes
      const now = Date.now();
      try {
        const raw = sessionStorage.getItem(key);
        if (raw) {
          const cached = JSON.parse(raw);
          if (cached && cached.t && (now - cached.t) < ttlMs && Array.isArray(cached.data)) {
            return Promise.resolve(cached.data);
          }
        }
      } catch (_) {}
      return fetch(url, { mode: 'cors' })
        .then(res => { if (!res.ok) throw new Error('HTTP ' + res.status); return res.json(); })
        .then(data => {
          try { sessionStorage.setItem(key, JSON.stringify({ t: now, data })); } catch (_) {}
          return data;
        })
        .catch(e => { console.warn('fetch error:', e); return []; });
    }

    async function fetchJson(url) {
      try {
        const res = await fetch(url, { mode: 'cors' });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        return await res.json();
      } catch (e) {
        console.warn('fetch error:', e);
        return [];
      }
    }

    // Try local static first; then fallback to live GAS; cache result
  async function fetchStaticThenLive(staticUrl, liveUrl, key) {
      // First try static
      try {
        const res = await fetch(staticUrl, { cache: 'no-cache' });
        if (res.ok) {
          const data = await res.json();
          if (Array.isArray(data) && data.length > 0) return data;
        }
      } catch (_) {}
      // Fallback to live + cache
      return fetchJsonCached(liveUrl, key);
    }

    // 공지사항
    async function loadAnnouncements() {
      if (!CONFIG.ANNOUNCEMENTS_URL) return;
  const rows = await fetchStaticThenLive(CONFIG.ANNOUNCEMENTS_STATIC, CONFIG.ANNOUNCEMENTS_URL, 'ann-v1');
      // 최신 날짜 우선 정렬 (YYYY-MM-DD 가정)
  rows.sort((a,b) => dateKey(b.date).localeCompare(dateKey(a.date)));

      let current = 1;
      const tbody = document.getElementById('ann-tbody');
      const pager = document.getElementById('ann-pager');

      const draw = () => {
        const { slice, pages, page } = paginate(rows, current);
        tbody.innerHTML = '';
        slice.forEach((r, idx) => {
          const tr = document.createElement('tr');
          const tdDate = document.createElement('td');
          tdDate.className = 'date-cell';
          tdDate.textContent = fmtDate(r.date);
          const tdTitle = document.createElement('td');
          tdTitle.className = 'title-cell';
          const exp = document.createElement('span');
          exp.className = 'expander';
          exp.textContent = r.title || '공지';
          tdTitle.appendChild(exp);
          const tdAct = document.createElement('td');
          tdAct.className = 'actions';
          if (r.link) {
            const a = document.createElement('a');
            a.className = 'btn'; a.target = '_blank'; a.rel = 'noopener';
            a.href = r.link; a.textContent = '원문';
            tdAct.appendChild(a);
          }
          tr.appendChild(tdDate); tr.appendChild(tdTitle); tr.appendChild(tdAct);
          tbody.appendChild(tr);

          // content row
          const trC = document.createElement('tr');
          trC.className = 'content-row';
          const tdC = document.createElement('td'); tdC.colSpan = 3;
          const box = document.createElement('div'); box.className = 'content-box';
          box.style.display = 'none';
          // Safely render body with newline -> <br>
          const safeBody = escapeHTML(r.body || '').replace(/\n/g, '<br>');
          box.innerHTML = safeBody;
          tdC.appendChild(box);
          trC.appendChild(tdC);
          tbody.appendChild(trC);

          exp.addEventListener('click', () => {
            box.style.display = (box.style.display === 'none') ? '' : 'none';
          });
        });
        renderPager(pager, pages, page, (p) => { current = p; draw(); });
      };

      draw();
    }

    // 주보
    async function loadBulletins() {
      if (!CONFIG.BULLETINS_URL) return;
  const rows = await fetchStaticThenLive(CONFIG.BULLETINS_STATIC, CONFIG.BULLETINS_URL, 'bul-v1');
  rows.sort((a,b) => dateKey(b.date).localeCompare(dateKey(a.date)));

      let current = 1;
      const tbody = document.getElementById('bul-tbody');
      const pager = document.getElementById('bul-pager');

      const draw = () => {
        const { slice, pages, page } = paginate(rows, current);
        tbody.innerHTML = '';
        slice.forEach(r => {
          const tr = document.createElement('tr');
          const tdDate = document.createElement('td'); tdDate.className = 'date-cell'; tdDate.textContent = fmtDate(r.date);
          const tdTitle = document.createElement('td'); tdTitle.className = 'title-cell'; tdTitle.textContent = r.title || '주보';
          const tdAct = document.createElement('td'); tdAct.className = 'actions';
          const a = document.createElement('a');
          a.className = 'btn'; a.target = '_blank'; a.rel = 'noopener';
          a.href = r.type === 'pdf' ? (r.fileUrl || r.previewUrl || '#') : (r.fileUrl || '#');
          a.textContent = '보기';
          tdAct.appendChild(a);
          tr.appendChild(tdDate); tr.appendChild(tdTitle); tr.appendChild(tdAct);
          tbody.appendChild(tr);
        });
        renderPager(pager, pages, page, (p) => { current = p; draw(); });
      };

      draw();
    }

    // 앨범
    function postToAlbumGate(pw, albumUrl) {
      if (!CONFIG.ALBUM_GATE_URL) return alert('앨범 게이트가 설정되지 않았습니다.');
      const f = document.createElement('form');
      f.method = 'POST';
      f.action = CONFIG.ALBUM_GATE_URL;
      f.target = '_blank';
      const pwi = document.createElement('input'); pwi.type = 'hidden'; pwi.name = 'pw'; pwi.value = pw; f.appendChild(pwi);
      const al = document.createElement('input'); al.type = 'hidden'; al.name = 'album'; al.value = albumUrl; f.appendChild(al);
      document.body.appendChild(f);
      f.submit();
      setTimeout(() => f.remove(), 500);
    }

    async function openAlbumAfterVerify(pw, albumUrl, opts = {}) {
      if (!CONFIG.ALBUM_GATE_URL) { alert('앨범 게이트가 설정되지 않았습니다.'); return; }
      const fallbackOnFail = opts.fallbackOnFail !== false; // default true
      try {
        const body = new URLSearchParams({ pw, album: albumUrl, mode: 'json' });
        const res = await fetch(CONFIG.ALBUM_GATE_URL, { method: 'POST', body });
        // 기대 응답: { ok: true, url: 'https://photos.app.goo.gl/...' }
        const data = await res.json().catch(() => null);
        if (data && data.ok && data.url) {
          return { ok: true, url: data.url };
        }
        // 실패 시 폴백: 기존 폼 POST로 서버 리다이렉트 시도 (옵션)
        if (fallbackOnFail) postToAlbumGate(pw, albumUrl);
        return { ok: false, url: null };
      } catch (e) {
        // 네트워크/JSON 실패 시 폴백 (옵션)
        if (fallbackOnFail) postToAlbumGate(pw, albumUrl);
        return { ok: false, url: null };
      }
    }

    function normalizeDriveThumb(url) {
      if (!url) return url;
      // Already a Drive thumbnail link
      if (/drive\.google\.com\/thumbnail\?/.test(url)) return url;
      // uc?export=view&id=FILE_ID
      const uc = url.match(/uc\?[^#]*[?&]id=([^&#]+)/);
      if (uc && uc[1]) return `https://drive.google.com/thumbnail?id=${uc[1]}&sz=w300`;
      // file/d/FILE_ID/view
      const m = url.match(/drive\.google\.com\/file\/d\/([^/]+)\/view/);
      if (m && m[1]) return `https://drive.google.com/thumbnail?id=${m[1]}&sz=w300`;
      // open?id=FILE_ID
      const o = url.match(/drive\.google\.com\/open\?id=([^&#]+)/);
      if (o && o[1]) return `https://drive.google.com/thumbnail?id=${o[1]}&sz=w300`;
      return url;
    }

    function extractDriveFolderId(url) {
      if (!url) return null;
      // /drive/folders/ID or /drive/u/0/folders/ID
      let m = url.match(/drive\.google\.com\/drive\/u\/\d+\/folders\/([^/?#]+)/);
      if (m && m[1]) return m[1];
      m = url.match(/drive\.google\.com\/drive\/folders\/([^/?#]+)/);
      if (m && m[1]) return m[1];
      // open?id=ID or folderview?id=ID
      m = url.match(/drive\.google\.com\/(?:open|folderview)\?[^#]*[?&]id=([^&#]+)/);
      if (m && m[1]) return m[1];
      return null;
    }

    function toDriveFolderEmbedUrl(url) {
      const id = extractDriveFolderId(url);
      return id ? `https://drive.google.com/embeddedfolderview?id=${id}#grid` : null;
    }

    async function loadAlbums() {
      if (!CONFIG.ALBUMS_URL) return;
  const rows = await fetchStaticThenLive(CONFIG.ALBUMS_STATIC, CONFIG.ALBUMS_URL, 'alb-v1');
      // 기대 필드: {date, title, thumbUrl, albumUrl}
  rows.sort((a,b) => dateKey(b.date).localeCompare(dateKey(a.date)));

      let current = 1;
      const tbody = document.getElementById('alb-tbody');
      const pager = document.getElementById('alb-pager');
      const verified = new Set();
      // Session-scoped password helpers with short TTL (30 minutes)
      const PW_TTL = 30 * 60 * 1000;
      const getSavedPw = () => {
        try {
          const raw = sessionStorage.getItem('albumPw');
          if (!raw) return '';
          // Backward compatible: plain string or JSON {pw,t}
          if (raw.startsWith('{')) {
            const obj = JSON.parse(raw);
            const now = Date.now();
            if (obj && typeof obj.pw === 'string' && typeof obj.t === 'number' && (now - obj.t) < PW_TTL) {
              return obj.pw;
            }
            // expired
            sessionStorage.removeItem('albumPw');
            return '';
          }
          return raw; // legacy
        } catch (_) { return ''; }
      };
      const savePw = (pw) => {
        try { sessionStorage.setItem('albumPw', JSON.stringify({ pw, t: Date.now() })); } catch (_) {}
      };
      const clearPw = () => { try { sessionStorage.removeItem('albumPw'); } catch (_) {} };

      const draw = () => {
        const { slice, pages, page } = paginate(rows, current);
        tbody.innerHTML = '';
        slice.forEach(r => {
          const tr = document.createElement('tr');
          const tdDate = document.createElement('td'); tdDate.className = 'date-cell'; tdDate.textContent = fmtDate(r.date);
          const tdTitle = document.createElement('td'); tdTitle.className = 'title-cell'; tdTitle.textContent = r.title || '앨범';
          const tdThumb = document.createElement('td');
          const img = document.createElement('img'); img.className = 'thumb'; img.alt = r.title || '앨범'; img.loading = 'lazy';
          img.src = normalizeDriveThumb(r.thumbUrl) || 'https://via.placeholder.com/96x72?text=Album';
          tdThumb.appendChild(img);
          const tdAct = document.createElement('td'); tdAct.className = 'actions';
          const btn = document.createElement('a'); btn.href = 'javascript:void(0)'; btn.className = 'btn'; btn.textContent = '열기';
          tr.appendChild(tdDate); tr.appendChild(tdTitle); tr.appendChild(tdThumb); tr.appendChild(tdAct);
          tbody.appendChild(tr);

          // Embed row under this album
          const trE = document.createElement('tr'); trE.className = 'embed-row';
          const tdE = document.createElement('td'); tdE.colSpan = 4;
          const box = document.createElement('div'); box.className = 'embed-box';
          const hint = document.createElement('div'); hint.className = 'hint';
          hint.textContent = '비밀번호 통과 후 폴더가 이곳에 표시됩니다.';
          box.appendChild(hint);
          tdE.appendChild(box);
          trE.appendChild(tdE);
          tbody.appendChild(trE);

          const closeOthers = (exceptEl) => {
            const albSection = document.getElementById('alb');
            if (!albSection) return;
            albSection.querySelectorAll('.embed-box').forEach(el => {
              if (el !== exceptEl) el.style.display = 'none';
            });
          };

          const showEmbed = (embedUrl, forceOpen = false) => {
            if (!embedUrl) { window.open(r.albumUrl, '_blank', 'noopener'); return; }
            if (!box.querySelector('iframe')) {
              const ifr = document.createElement('iframe');
              ifr.className = 'drive-embed';
              ifr.loading = 'lazy';
              ifr.referrerPolicy = 'no-referrer';
              ifr.src = embedUrl;
              box.appendChild(ifr);
            }
            // Close other open embeds before showing this one
            closeOthers(box);
            if (forceOpen) {
              box.style.display = 'block';
            } else {
              box.style.display = (box.style.display === 'none' || box.style.display === '') ? 'block' : 'none';
            }
          };

          btn.addEventListener('click', async () => {
            if (!r.albumUrl) return;
            // Toggle if already verified and iframe exists
            if (verified.has(r.albumUrl) && box.querySelector('iframe')) {
              // Close others, then toggle this one
              closeOthers(box);
              box.style.display = (box.style.display === 'none' || box.style.display === '') ? 'block' : 'none';
              return;
            }
            // 1) Try cached password silently
            let pw = getSavedPw();
            if (pw) {
              const cachedTry = await openAlbumAfterVerify(pw, r.albumUrl, { fallbackOnFail: false });
              if (cachedTry && cachedTry.ok) {
                verified.add(r.albumUrl);
                const embedUrl = toDriveFolderEmbedUrl(cachedTry.url || r.albumUrl);
                if (embedUrl) {
                  showEmbed(embedUrl, true);
                } else {
                  window.open(cachedTry.url || r.albumUrl, '_blank', 'noopener');
                }
                return;
              } else {
                // Cached password invalid -> clear and prompt once
                clearPw();
              }
            }

            // 2) Prompt once
            pw = prompt('앨범 비밀번호를 입력하세요');
            if (!pw) return;
            const result = await openAlbumAfterVerify(pw, r.albumUrl); // fallback allowed
            if (result && result.ok) {
              savePw(pw);
              verified.add(r.albumUrl);
              const embedUrl = toDriveFolderEmbedUrl(result.url || r.albumUrl);
              if (embedUrl) {
                showEmbed(embedUrl, true);
              } else {
                // Not a Drive folder -> open in new tab
                window.open(result.url || r.albumUrl, '_blank', 'noopener');
              }
            } else {
              // Fallback already attempted form POST which opens new tab
              alert('임베드 모드에는 서버 JSON 응답이 필요합니다. 새 창으로 열렸습니다.');
            }
          });

          tdAct.appendChild(btn);
        });
        renderPager(pager, pages, page, (p) => { current = p; draw(); });
      };

      draw();
    }

    (async () => {
      // Load announcements immediately (top content, likely needed first)
      loadAnnouncements();

      // Lazy load bulletins and albums when their section enters viewport
      const io = 'IntersectionObserver' in window ? new IntersectionObserver((entries, obs) => {
        for (const e of entries) {
          if (!e.isIntersecting) continue;
          const id = e.target.getAttribute('id');
          if (id === 'bul') {
            loadBulletins();
          } else if (id === 'alb') {
            loadAlbums();
          }
          obs.unobserve(e.target);
        }
      }, { rootMargin: '100px 0px' }) : null;

      const bul = document.getElementById('bul');
      const alb = document.getElementById('alb');
      if (io && bul) io.observe(bul); else loadBulletins();
      if (io && alb) io.observe(alb); else loadAlbums();
    })();
  </script>
</body>
</html>
